[![Linux](https://github.com/kaspermarstal/plprql/actions/workflows/test.yml/badge.svg)](https://github.com/kaspermarstal/plprql/actions/workflows/test.yml)

# PRQL in PostgreSQL!

PL/PRQL is a PostgreSQL extension that lets you write functions with PRQL. The extension supports PostgreSQL v12-16 on Linux and macOS.



## Key features
PRQL shines when your SQL queries becomes very long and complex. You can manage this complexity by porting your most impressive SQL incantations to PRQL functions, which can then be used in dashboards, business logic or other database code. For example:

```sql
create function match_stats(int) returns table(player text, kd_ratio float) as $$
  from matches
  filter match_id == $1
  group player (
    aggregate {
      total_kills = sum kills,
      total_deaths = sum deaths
    }
  )
  filter total_deaths > 0
  derive kd_ratio = total_kills / total_deaths
  select { player, kd_ratio }
$$ language plprql;

select * from match_stats(1001)
    
 player  | kd_ratio 
---------+----------
 Player1 |    0.625
 Player2 |      1.6
(2 rows)
```

You can see the compiled SQL query with `prql_to_sql()` which is also useful for debugging:

```sql
select prql_to_sql(...); -- statements above omitted for brevity

 prql_to_sql 
-------------
WITH table_0 AS (
  SELECT
    player,
    COALESCE(SUM(kills), 0) AS _expr_0,
    COALESCE(SUM(deaths), 0) AS _expr_1
  FROM
    matches
  WHERE
    match_id = $1
  GROUP BY
    player
)
SELECT
  player,
  _expr_0 / _expr_1 AS kd_ratio
FROM
  table_0
WHERE
  _expr_1 > 0
-- Generated by PRQL compiler version:0.11.1 (https://prql-lang.org)
(1 row)
```

You can also run PRQL directly with the `prql` function which is useful for custom SQL in ORMs:
 
```sql
select prql('from matches | filter player == ''Player1''', 'player1_cursor');

fetch 2 from player1_cursor;

 id | match_id | round | player  | kills | deaths 
----+----------+-------+---------+-------+--------
  1 |     1001 |     1 | Player1 |     4 |      1
  3 |     1001 |     2 | Player1 |     1 |      7
(2 rows)
```

For more information on the design of the extension, see the [design document](DESIGN.md). 

For more information on PRQL, visit the PRQL [website](https://prql-lang.org/), [playground](https://prql-lang.org/playground/) or [repository](https://github.com/PRQL/prql). 

> [!NOTE]
>
> PRQL supports `select` statements only. `insert`, `update`, and `delete` statements, and other database code, will continue to live in vanilla SQL, ORMs, or other database frameworks.

## Getting started
On Ubuntu, follow these steps to install PL/PRQL from source:

1. Install `cargo-pgrx`.

    ```cmd
    cargo install --locked --version=0.11.2 cargo-pgrx
    ```

    The version of `cargo-pgrx` must match the version of `pgrx` in `Cargo.toml`. 

2. Initialize `pgrx` for your system.
   ```cmd
   cargo pgrx init --pg16 <PG16>
   ```
   where `<PG16>` is the path to your system installation's `pg_config` tool (typically `/usr/bin/pg_config`). Supported versions are PostgreSQL v12-16. You can also run `cargo pgrx init` and have `pgrx` download, install, and compile PostgreSQL v12-16. These installations are managed by `pgrx` and used for development and testing. Individual `pgrx` installations can be installed using e.g. `cargo pgrx init --pg16 download`. 

3. Clone this repository and `cd` into root directory.

    ```cmd
    git clone https://github.com/kaspermarstal/plprql
    cd plprql
    ```
   
4. Install the extension to the PostgreSQL specified by
   the `pg_config` currently on your `$PATH`.
   ```cmd
   cd plprql
   cargo pgrx install --release
   ```
   You can target a specific PostgreSQL installation by providing the path of another `pg_config` using the `-c` flag.
   
5. Fire up PostgreSQL and start writing functions right away!
   ```cmd
   $ cargo pgrx run pg16
   psql> create extension plprql;
   psql> create function match_stats(int) 
         returns table(total_kills real, total_deaths real) as $$
           from rounds
           filter match_id == $1
           aggregate {
             total_kills = sum kills,
             total_deaths = sum deaths
           }
         $$ language plprql
   psql> select match_stats(1);
   ```

## Running Tests 
You can now run tests using `cargo pgrx test`. To run tests for all supported versions of PostgreSQL, run

```cmd
cargo pgrx test pg16
cargo pgrx test pg15
cargo pgrx test pg14
cargo pgrx test pg13
cargo pgrx test pg12
```

## License
Apache 2.0 License
